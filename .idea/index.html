<!-- Th√™m v√†o ph·∫ßn <head> c·ªßa index.html hi·ªán t·∫°i -->
<script>
    // ==================== C·∫§U H√åNH API ====================
    const API_BASE_URL = 'http://localhost:5000/api';
    let currentUser = null;
    let authToken = null;

    // ==================== H·ªÜ TH·ªêNG ƒêƒÇNG K√ù/ƒêƒÇNG NH·∫¨P ====================

    // Hi·ªÉn th·ªã form ƒëƒÉng k√Ω
    function showRegisterForm() {
        document.getElementById('authContainer').innerHTML = `
            <div class="auth-form">
                <h3><i class="fas fa-user-plus"></i> T·∫°o t√†i kho·∫£n m·ªõi</h3>
                <div class="form-group">
                    <label>Email (@gmail.com):</label>
                    <input type="email" id="regEmail" placeholder="username@gmail.com" class="form-control">
                    <small class="text-muted">Ch·ªâ h·ªó tr·ª£ email @gmail.com</small>
                </div>
                <div class="form-group">
                    <label>M·∫≠t kh·∫©u:</label>
                    <input type="password" id="regPassword" placeholder="√çt nh·∫•t 6 k√Ω t·ª±" class="form-control">
                </div>
                <button class="btn btn-primary btn-block" onclick="sendOTP()">
                    <i class="fas fa-paper-plane"></i> G·ª≠i m√£ OTP
                </button>

                <div id="otpSection" style="display: none; margin-top: 20px;">
                    <div class="form-group">
                        <label>M√£ OTP (6 s·ªë):</label>
                        <input type="text" id="otpCode" placeholder="Nh·∫≠p m√£ t·ª´ email" class="form-control" maxlength="6">
                        <small class="text-muted">M√£ c√≥ hi·ªáu l·ª±c trong 2 ph√∫t</small>
                    </div>
                    <button class="btn btn-success btn-block" onclick="completeRegistration()">
                        <i class="fas fa-check-circle"></i> X√°c th·ª±c & ƒêƒÉng k√Ω
                    </button>
                </div>

                <div class="text-center mt-3">
                    <a href="#" onclick="showLoginForm()">ƒê√£ c√≥ t√†i kho·∫£n? ƒêƒÉng nh·∫≠p</a>
                </div>
            </div>
        `;
    }

    // G·ª≠i OTP ƒë·∫øn email
    async function sendOTP() {
        const email = document.getElementById('regEmail').value;
        const password = document.getElementById('regPassword').value;

        if (!email.endsWith('@gmail.com')) {
            alert('Vui l√≤ng s·ª≠ d·ª•ng email @gmail.com');
            return;
        }

        if (password.length < 6) {
            alert('M·∫≠t kh·∫©u ph·∫£i c√≥ √≠t nh·∫•t 6 k√Ω t·ª±');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/auth/send-otp`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email })
            });

            const data = await response.json();

            if (data.success) {
                document.getElementById('otpSection').style.display = 'block';
                alert('‚úÖ M√£ OTP ƒë√£ ƒë∆∞·ª£c g·ª≠i ƒë·∫øn email c·ªßa b·∫°n!');
                localStorage.setItem('pendingEmail', email);
                localStorage.setItem('pendingPassword', password);

                // ƒê·∫øm ng∆∞·ª£c 2 ph√∫t
                startOTPTimer(120);
            } else {
                alert('‚ùå ' + data.error);
            }
        } catch (error) {
            console.error('L·ªói g·ª≠i OTP:', error);
            alert('‚ùå Kh√¥ng th·ªÉ g·ª≠i OTP. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // Ho√†n t·∫•t ƒëƒÉng k√Ω v·ªõi OTP
    async function completeRegistration() {
        const email = localStorage.getItem('pendingEmail');
        const password = localStorage.getItem('pendingPassword');
        const otp = document.getElementById('otpCode').value;

        if (!email || !password || !otp) {
            alert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin');
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password, otp })
            });

            const data = await response.json();

            if (data.success) {
                // L∆∞u token v√† th√¥ng tin ng∆∞·ªùi d√πng
                authToken = data.token;
                currentUser = data.user;
                localStorage.setItem('authToken', authToken);
                localStorage.setItem('currentUser', JSON.stringify(currentUser));

                // X√≥a th√¥ng tin t·∫°m
                localStorage.removeItem('pendingEmail');
                localStorage.removeItem('pendingPassword');

                alert('üéâ ƒêƒÉng k√Ω th√†nh c√¥ng!');
                updateUIForLoggedInUser();
                loadUserQuizzes();
            } else {
                alert('‚ùå ' + data.error);
            }
        } catch (error) {
            console.error('L·ªói ƒëƒÉng k√Ω:', error);
            alert('‚ùå Kh√¥ng th·ªÉ ƒëƒÉng k√Ω. Vui l√≤ng th·ª≠ l·∫°i.');
        }
    }

    // ==================== X·ª¨ L√ù ·∫¢NH V·ªöI AI BACKEND ====================

    async function processImageWithAIBackend(imageFiles) {
        showLoading('AI ƒëang ph√¢n t√≠ch ·∫£nh...');

        const formData = new FormData();

        // Th√™m t·ªëi ƒëa 10 ·∫£nh
        const filesToUpload = Array.from(imageFiles).slice(0, 10);
        filesToUpload.forEach((file, index) => {
            if (index === 0) {
                formData.append('image', file); // ·∫¢nh ch√≠nh
            } else {
                formData.append('images', file); // C√°c ·∫£nh b·ªï sung
            }
        });

        try {
            const response = await fetch(`${API_BASE_URL}/ai/process-image`, {
                method: 'POST',
                body: formData
                // Note: Kh√¥ng c·∫ßn Content-Type header v·ªõi FormData
            });

            const data = await response.json();
            hideLoading();

            if (data.success) {
                // X·ª≠ l√Ω k·∫øt qu·∫£ t·ª´ AI
                const questions = [];

                data.results.forEach((result, index) => {
                    if (result.question && result.options.length > 0) {
                        questions.push({
                            id: Date.now() + index,
                            question: result.question,
                            options: result.options,
                            correctAnswer: result.correctAnswer,
                            sourceImage: result.fileName,
                            explanation: `T·ª± ƒë·ªông t·∫°o t·ª´ ·∫£nh: ${result.fileName}`
                        });
                    }
                });

                if (questions.length > 0) {
                    // T·∫°o quiz t·ª´ k·∫øt qu·∫£ AI
                    createQuizFromAIResults(questions);
                    alert(`‚úÖ ƒê√£ t·∫°o ${questions.length} c√¢u h·ªèi t·ª´ ${data.results.length} ·∫£nh`);
                } else {
                    alert('‚ö†Ô∏è Kh√¥ng th·ªÉ t·∫°o c√¢u h·ªèi t·ª´ ·∫£nh. Vui l√≤ng th·ª≠ ·∫£nh kh√°c.');
                }
            } else {
                alert('‚ùå ' + data.error);
            }
        } catch (error) {
            hideLoading();
            console.error('L·ªói x·ª≠ l√Ω ·∫£nh AI:', error);
            alert('‚ùå Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn AI Service. Vui l√≤ng th·ª≠ l·∫°i sau.');
        }
    }

    // ==================== L∆ØU QUIZ C√Å NH√ÇN ====================

    async function saveUserQuiz(quizData) {
        if (!authToken || !currentUser) {
            alert('Vui l√≤ng ƒëƒÉng nh·∫≠p ƒë·ªÉ l∆∞u quiz!');
            showRegisterForm();
            return;
        }

        try {
            const response = await fetch(`${API_BASE_URL}/user/save-quiz`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${authToken}`
                },
                body: JSON.stringify({
                    title: quizData.title || `Quiz ${new Date().toLocaleDateString()}`,
                    questions: quizData.questions,
                    tags: ['ai-generated', 'from-image']
                })
            });

            const data = await response.json();

            if (data.success) {
                alert('‚úÖ ƒê√£ l∆∞u quiz v√†o t√†i kho·∫£n c·ªßa b·∫°n!');
                return data.quizId;
            } else {
                alert('‚ùå ' + data.error);
                return null;
            }
        } catch (error) {
            console.error('L·ªói l∆∞u quiz:', error);
            alert('‚ùå Kh√¥ng th·ªÉ l∆∞u quiz. Vui l√≤ng th·ª≠ l·∫°i.');
            return null;
        }
    }

    // ==================== T·∫¢I QUIZ C√Å NH√ÇN ====================

    async function loadUserQuizzes() {
        if (!authToken) return;

        try {
            const response = await fetch(`${API_BASE_URL}/user/quizzes`, {
                method: 'GET',
                headers: {
                    'Authorization': `Bearer ${authToken}`
                }
            });

            const data = await response.json();

            if (data.success) {
                displayUserQuizzes(data.quizzes, data.stats);
            }
        } catch (error) {
            console.error('L·ªói t·∫£i quizzes:', error);
        }
    }

    // ==================== KH·ªûI ƒê·ªòNG ·ª®NG D·ª§NG ====================

    document.addEventListener('DOMContentLoaded', function() {
        // Ki·ªÉm tra token ƒë√£ l∆∞u
        const savedToken = localStorage.getItem('authToken');
        const savedUser = localStorage.getItem('currentUser');

        if (savedToken && savedUser) {
            authToken = savedToken;
            currentUser = JSON.parse(savedUser);
            updateUIForLoggedInUser();
            loadUserQuizzes();
        }

        // C·∫≠p nh·∫≠t n√∫t upload ·∫£nh ƒë·ªÉ d√πng AI backend
        const imageUploadBtn = document.getElementById('imageUploadBtn');
        if (imageUploadBtn) {
            imageUploadBtn.onclick = function() {
                const fileInput = document.getElementById('imageUploadInput');
                if (fileInput.files.length > 0) {
                    processImageWithAIBackend(fileInput.files);
                }
            };
        }
    });

    // C·∫≠p nh·∫≠t UI khi ƒë√£ ƒëƒÉng nh·∫≠p
    function updateUIForLoggedInUser() {
        if (currentUser) {
            document.getElementById('userInfo').innerHTML = `
                <div class="user-profile">
                    <i class="fas fa-user-circle"></i>
                    <span>${currentUser.email}</span>
                    <button class="btn btn-sm btn-outline-secondary" onclick="logout()">
                        <i class="fas fa-sign-out-alt"></i> ƒêƒÉng xu·∫•t
                    </button>
                </div>
            `;
        }
    }

    // ƒêƒÉng xu·∫•t
    function logout() {
        authToken = null;
        currentUser = null;
        localStorage.removeItem('authToken');
        localStorage.removeItem('currentUser');
        location.reload();
    }

    // ƒê·∫øm ng∆∞·ª£c OTP
    function startOTPTimer(seconds) {
        const timerElement = document.createElement('div');
        timerElement.id = 'otpTimer';
        timerElement.className = 'otp-timer';
        document.getElementById('otpSection').appendChild(timerElement);

        let timeLeft = seconds;

        const timer = setInterval(() => {
            const minutes = Math.floor(timeLeft / 60);
            const seconds = timeLeft % 60;

            timerElement.innerHTML = `‚è≥ M√£ OTP c√≤n hi·ªáu l·ª±c: ${minutes}:${seconds.toString().padStart(2, '0')}`;

            if (timeLeft <= 0) {
                clearInterval(timer);
                timerElement.innerHTML = '‚è∞ M√£ OTP ƒë√£ h·∫øt h·∫°n';
                timerElement.style.color = 'var(--danger)';
            }

            timeLeft--;
        }, 1000);
    }
</script>

<!-- Th√™m CSS cho ph·∫ßn ƒëƒÉng k√Ω -->
<style>
    .auth-form {
        background: white;
        padding: 2rem;
        border-radius: 15px;
        box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        max-width: 400px;
        margin: 2rem auto;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-control {
        width: 100%;
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        border-color: var(--primary);
        outline: none;
    }

    .btn-block {
        width: 100%;
        padding: 1rem;
        font-size: 1.1rem;
    }

    .user-profile {
        display: flex;
        align-items: center;
        gap: 1rem;
        padding: 0.5rem 1rem;
        background: rgba(67, 97, 238, 0.1);
        border-radius: 50px;
        margin-left: auto;
    }

    .otp-timer {
        text-align: center;
        font-weight: bold;
        color: var(--primary);
        margin-top: 1rem;
        padding: 0.5rem;
        background: #f8f9ff;
        border-radius: 10px;
    }
</style>